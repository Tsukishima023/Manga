<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>欠陥品の記憶 — 第1話</title>
<style>
  :root{
    --bg:#0b0f12; --card:#12181e; --line:#2a3138;
    --text:#dfe8f1; --muted:#92b7d9; --accent:#f07b7b;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family: "Hiragino Mincho ProN", "游明朝", YuMincho, "Yu Mincho", "MS PMincho", serif;}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(to bottom, rgba(11,15,18,.95), rgba(11,15,18,.7));backdrop-filter: blur(4px);border-bottom:1px solid var(--line);}
  .bar{max-width:980px;margin:0 auto;display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;}
  .title{font-size:1rem; letter-spacing:.08em;}
  .spacer{flex:1;}
  .btn{appearance:none;border:1px solid var(--line);background:#0f1419;color:var(--text);padding:.45rem .7rem;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#3a4350}
  .btn[disabled]{opacity:.35;cursor:default}
  .progress{font-size:.85rem;color:var(--muted)}
  main{max-width:980px;margin:0 auto;padding:1rem .5rem 6rem;}
  figure{margin:0 0 1rem 0;background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  figure img{display:block;width:100%;height:auto;image-rendering:auto}
  .foot{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:.5rem}
  .foot .btn{border-radius:12px}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">欠陥品の記憶 — 第1話</div>
      <div class="spacer"></div>
      <div class="progress" id="prog">0 / 0</div>
      <button class="btn" id="prevBtn" title="前のページ（←）">前へ</button>
      <button class="btn" id="nextBtn" title="次のページ（→）">次へ</button>
    </div>
  </header>

  <main id="viewer"></main>

  <div class="foot">
    <button class="btn" id="topBtn" title="最上部へ">↑ Top</button>
  </div>

<script>
(async () => {
  // manifest.json を取得
  const res = await fetch('manifest.json', {cache:'no-store'});
  if(!res.ok){
    document.getElementById('viewer').innerHTML =
      '<p style="color:#f88;padding:1rem;">manifest.json が読み込めませんでした。</p>';
    return;
  }
  /** @type {string[]} */
  let files = await res.json();

  // 画像以外が入っていた場合の簡易フィルター（webp/jpg/jpegのみ）
  files = files.filter(n => /\.(webp|jpg|jpeg)$/i.test(n));
  files.sort(); // 念のためソート

  const viewer = document.getElementById('viewer');
  const prog = document.getElementById('prog');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const topBtn  = document.getElementById('topBtn');

  if(files.length === 0){
    viewer.innerHTML = '<p style="padding:1rem;">ページ画像が見つかりません。</p>';
    return;
  }

  // 画像を並べる（lazy）
  files.forEach((name, idx) => {
    const fig = document.createElement('figure');
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.decoding = 'async';
    img.alt = `p${idx+1}`;
    img.src = name;
    fig.appendChild(img);
    viewer.appendChild(fig);
  });

  // ページ位置から現在ページを推定（単純に画面上端に一番近いimg）
  const imgs = [...viewer.querySelectorAll('img')];
  const updateProgress = () => {
    let active = 1;
    const y = window.scrollY + 80; // ヘッダ分
    for(let i=0;i<imgs.length;i++){
      const rect = imgs[i].getBoundingClientRect();
      const top = rect.top + window.scrollY;
      if(top <= y) active = i+1; else break;
    }
    prog.textContent = `${active} / ${imgs.length}`;
    prevBtn.disabled = (active <= 1);
    nextBtn.disabled = (active >= imgs.length);
  };

  const scrollToPage = (p) => {
    const i = Math.min(Math.max(1, p), imgs.length) - 1;
    imgs[i].scrollIntoView({behavior:'smooth', block:'start'});
  };

  // ボタンとキー操作
  prevBtn.addEventListener('click', () => {
    const now = parseInt(prog.textContent.split('/')[0]);
    scrollToPage(now - 1);
  });
  nextBtn.addEventListener('click', () => {
    const now = parseInt(prog.textContent.split('/')[0]);
    scrollToPage(now + 1);
  });
  topBtn.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
  window.addEventListener('scroll', updateProgress, {passive:true});
  window.addEventListener('resize', updateProgress);
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'ArrowRight') nextBtn.click();
    if(e.key === 'ArrowLeft')  prevBtn.click();
    if(e.key.toLowerCase() === 'h') window.scrollTo({top:0, behavior:'smooth'});
  });

  // 初期表示
  updateProgress();
})();
</script>
</body>
</html>
